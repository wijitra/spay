var $ = require('underscore');

var meta = {
    '00': {
        //Connection
        inputMatch: /\%(00)\,([a-z0-9A-Z._]+)\=(\d{6})(0|1|2)\#/,
        outputMap: [
            ['version', 2],
            ['machineId', 3],
            ['status', 4]
        ]

    },
    '01': {
        //Request Topup
        inputMatch: /\%(01)(\d{2})(\d{2})\=(\d{10})\#/,
        outputMap: [
            ['typeMenu', 2],
            ['provider', 3],
            ['phoneNumber', 4]
        ]

    },
    '02':{
        //Confirm Topup
        inputMatch: /\%(02)\=(\d{2,5})\,(\d{2,5})\#/,
        outputMap: [
            ['menu', 2],
            ['money', 3]         
        ]
    }, 
    '03':{
        //Retry Confirm Topup
        inputMatch: /\%(03)\=(\d{1,4})\,(\d{1,4})\,(\d{20})\,(\d{10})00\#/,
        outputMap: [
            ['menu', 2],
            ['money', 3],
            ['sequence', 4],
            ['phoneNumber', 5]         
        ]
    }, 
    '04':{
        //Update Category Money
        inputMatch: /\%(04)(\d{1,4})\,(\d{1,4})\,(\d{20})\=([A-I]\-[0-9]+\,?)*00\#/,
        outputMap: [
            ['menu', 2],
            ['money', 3],
            ['sequence', 4],
            ['categoryMoney', 5]         
        ]
    }, 
    '08':{
        //Cancel Topup By User
        inputMatch: /\%(08)(\d{2})\=(\d{1,4})\,(\d{1,4})\,(\d{10})00\#/,
        outputMap: [
            ['step', 2],
            ['menu', 3],
            ['money', 4],
            ['phoneNumber', 5]         
        ]
    }

}

exports.parse = function(input) {
    var cmd = input.substring(1,3)
    var obj = meta[cmd];
    var result = input.match(obj.inputMatch)
    var ret = {
        command: cmd
    }

    if(result != null){
        $.each(obj.outputMap, function(item) {
            ret[item[0]] = result[item[1]]
        })
    }
    
    return ret;
}